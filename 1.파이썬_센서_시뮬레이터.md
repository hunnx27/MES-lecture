"""
MES ì„¼ì„œ ì‹œë®¬ë ˆì´í„°
- PLC/ì„¼ì„œ ì—­í• ì„ í•˜ëŠ” ë°ì´í„° ìƒì„±ê¸°
- MQTTë¥¼ í†µí•´ ì‹¤ì‹œê°„ ë°ì´í„° ì „ì†¡
"""

import paho.mqtt.client as mqtt
import json
import time
import random
from datetime import datetime

class SensorSimulator:
    def __init__(self, broker_host='localhost', broker_port=1883):
        self.client = mqtt.Client(client_id="sensor_simulator")
        self.broker_host = broker_host
        self.broker_port = broker_port
        self.is_running = False
        
        # ì„¼ì„œ ì„¤ì •
        self.sensors = {
            'temperature': {'min': 20, 'max': 30, 'unit': 'Â°C'},
            'pressure': {'min': 98, 'max': 100, 'unit': 'kPa'},
            'vibration': {'min': 0.5, 'max': 1.0, 'unit': 'mm/s'},
            'speed': {'min': 950, 'max': 1000, 'unit': 'RPM'}
        }
        
    def on_connect(self, client, userdata, flags, rc):
        if rc == 0:
            print("âœ… MQTT Broker ì—°ê²° ì„±ê³µ")
        else:
            print(f"âŒ ì—°ê²° ì‹¤íŒ¨. ì½”ë“œ: {rc}")
    
    def on_disconnect(self, client, userdata, rc):
        print("ğŸ”Œ MQTT Broker ì—°ê²° í•´ì œ")
    
    def generate_sensor_data(self, equipment_id='EQ-001'):
        """ì„¼ì„œ ë°ì´í„° ìƒì„±"""
        data = {
            'equipment_id': equipment_id,
            'timestamp': datetime.now().isoformat(),
            'temperature': round(random.uniform(
                self.sensors['temperature']['min'],
                self.sensors['temperature']['max']
            ), 2),
            'pressure': round(random.uniform(
                self.sensors['pressure']['min'],
                self.sensors['pressure']['max']
            ), 2),
            'vibration': round(random.uniform(
                self.sensors['vibration']['min'],
                self.sensors['vibration']['max']
            ), 2),
            'speed': random.randint(
                self.sensors['speed']['min'],
                self.sensors['speed']['max']
            )
        }
        return data
    
    def check_alarm_conditions(self, data):
        """ì•ŒëŒ ì¡°ê±´ ì²´í¬"""
        alarms = []
        
        if data['temperature'] > 28:
            alarms.append({
                'type': 'WARNING',
                'message': f"ì˜¨ë„ ê²½ê³ : {data['temperature']}Â°C (ì„ê³„ê°’: 28Â°C)",
                'timestamp': data['timestamp']
            })
        
        if data['pressure'] < 98.5:
            alarms.append({
                'type': 'WARNING',
                'message': f"ì••ë ¥ ì €í•˜: {data['pressure']}kPa (ìµœì†Œ: 98.5kPa)",
                'timestamp': data['timestamp']
            })
        
        if data['vibration'] > 0.9:
            alarms.append({
                'type': 'CRITICAL',
                'message': f"ì§„ë™ ê³¼ë‹¤: {data['vibration']}mm/s (ì„ê³„ê°’: 0.9mm/s)",
                'timestamp': data['timestamp']
            })
        
        return alarms
    
    def start(self, interval=1.0):
        """ì‹œë®¬ë ˆì´í„° ì‹œì‘"""
        try:
            # MQTT ì—°ê²°
            self.client.on_connect = self.on_connect
            self.client.on_disconnect = self.on_disconnect
            
            print(f"ğŸ“¡ MQTT Broker ì—°ê²° ì‹œë„: {self.broker_host}:{self.broker_port}")
            self.client.connect(self.broker_host, self.broker_port, 60)
            self.client.loop_start()
            
            self.is_running = True
            print("ğŸš€ ì„¼ì„œ ì‹œë®¬ë ˆì´í„° ì‹œì‘")
            print(f"â±ï¸  ë°ì´í„° ì „ì†¡ ì£¼ê¸°: {interval}ì´ˆ")
            print("-" * 60)
            
            while self.is_running:
                # ì„¼ì„œ ë°ì´í„° ìƒì„±
                sensor_data = self.generate_sensor_data()
                
                # MQTTë¡œ ì„¼ì„œ ë°ì´í„° ì „ì†¡
                self.client.publish(
                    'factory/sensor/data',
                    json.dumps(sensor_data),
                    qos=1
                )
                
                # ì•ŒëŒ ì²´í¬
                alarms = self.check_alarm_conditions(sensor_data)
                if alarms:
                    for alarm in alarms:
                        self.client.publish(
                            'factory/alarm',
                            json.dumps(alarm),
                            qos=1
                        )
                        print(f"âš ï¸  {alarm['type']}: {alarm['message']}")
                
                # ì½˜ì†” ì¶œë ¥
                print(f"ğŸ“Š [{sensor_data['timestamp']}] "
                      f"ì˜¨ë„: {sensor_data['temperature']}Â°C | "
                      f"ì••ë ¥: {sensor_data['pressure']}kPa | "
                      f"ì§„ë™: {sensor_data['vibration']}mm/s | "
                      f"ì†ë„: {sensor_data['speed']}RPM")
                
                time.sleep(interval)
                
        except KeyboardInterrupt:
            print("\nâ¹ï¸  ì‚¬ìš©ìì— ì˜í•´ ì¤‘ì§€ë¨")
        except Exception as e:
            print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        finally:
            self.stop()
    
    def stop(self):
        """ì‹œë®¬ë ˆì´í„° ì¤‘ì§€"""
        self.is_running = False
        self.client.loop_stop()
        self.client.disconnect()
        print("âœ… ì„¼ì„œ ì‹œë®¬ë ˆì´í„° ì¢…ë£Œ")


if __name__ == "__main__":
    # ì„¤ì •
    BROKER_HOST = 'localhost'  # MQTT Broker ì£¼ì†Œ
    BROKER_PORT = 1883         # MQTT Broker í¬íŠ¸
    INTERVAL = 1.0             # ë°ì´í„° ì „ì†¡ ì£¼ê¸°(ì´ˆ)
    
    # ì‹œë®¬ë ˆì´í„° ì‹¤í–‰
    simulator = SensorSimulator(BROKER_HOST, BROKER_PORT)
    simulator.start(INTERVAL)


"""
í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜:
pip install paho-mqtt

MQTT Broker ì„¤ì¹˜ (Mosquitto):
- Windows: https://mosquitto.org/download/
- Linux: sudo apt-get install mosquitto mosquitto-clients
- macOS: brew install mosquitto

ì‹¤í–‰ ë°©ë²•:
1. MQTT Broker ì‹œì‘: mosquitto
2. ì‹œë®¬ë ˆì´í„° ì‹¤í–‰: python sensor_simulator.py

í…ŒìŠ¤íŠ¸ (ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ):
mosquitto_sub -h localhost -t "factory/sensor/data" -v
mosquitto_sub -h localhost -t "factory/alarm" -v
"""